#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Fully Test

on:
  push:
    branches: [ master,dev-* ]
    tags: [ '*' ]
  pull_request:
    branches: [ master,dev-* ]

jobs:
  sql-check:
    name: Sql Script Check
    uses: ./.github/workflows/check-sql-script.yml

  pg-sql-check:
    name: Postgresql Script Check
    uses: ./.github/workflows/check-sql-pg-script.yml

  apache-rat-check:
    name: License Check
    uses: ./.github/workflows/check-license.yml

  spotless-check:
    name: Code Format Check
    uses: ./.github/workflows/check-code-format.yml

  qodana-check:
    name: Qodana Check
    uses: ./.github/workflows/check-qodana.yml

  third-party-dependencies-check:
    name: Third Party Dependencies Check
    uses: ./.github/workflows/check-third-party-dependencies.yml

  build-backend-test:
    name: Build Backend Test
    needs: third-party-dependencies-check
    uses: ./.github/workflows/build-backend-test.yml

  build-frontend-test:
    name: Build Frontend Test
    uses: ./.github/workflows/build-frontend-test.yml

  check-point:
    name: Check Point
    runs-on: ubuntu-latest
    needs:
      - sql-check
      - pg-sql-check
      - apache-rat-check
      - spotless-check
      - qodana-check
      - third-party-dependencies-check
      - build-backend-test
      - build-frontend-test
    steps:
      - name: Check Point
        run: |
          echo "All Tests Passed!"

  build-docker:
    name: Build Docker
    needs: check-point
    uses: ./.github/workflows/build-docker.yml

  integration-test:
    name: Integration Test
    needs: build-docker
    uses: ./.github/workflows/integration-test.yml

  publish-docker:
    name: Publish Docker
    needs: [build-docker, integration-test]
    if: startsWith(github.ref, 'refs/tags/')
    uses: ./.github/workflows/publish-docker.yml
    with:
      linkis-version: ${{ github.ref_name }}
