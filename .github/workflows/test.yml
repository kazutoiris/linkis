#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Test

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore
        uses: actions/cache/restore@v4
        id: cache
        with:
          path: linkis-build-cache
          key: ${{ runner.os }}-linkis-${{ hashFiles('linkis-dist/docker/scripts/prepare-ldh-image.sh') }}
          restore-keys: |
            ${{ runner.os }}-linkis-

      # - name: Download
      #   if: steps.cache.outputs.cache-hit != 'true'
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y aria2

      #     mkdir -p linkis-build-cache

      #     cd linkis-build-cache

      #     cat > ../download-list.txt << EOF
      #     https://archive.apache.org/dist/hadoop/common/hadoop-3.3.4/hadoop-3.3.4.tar.gz
      #     https://archive.apache.org/dist/hive/hive-3.1.3/apache-hive-3.1.3-bin.tar.gz
      #     https://archive.apache.org/dist/spark/spark-3.2.1/spark-3.2.1-bin-hadoop3.2.tgz
      #     https://archive.apache.org/dist/flink/flink-1.12.2/flink-1.12.2-bin-scala_2.11.tgz
      #     https://archive.apache.org/dist/zookeeper/zookeeper-3.5.9/apache-zookeeper-3.5.9-bin.tar.gz
      #     https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.28/mysql-connector-java-8.0.28.jar
      #     EOF

      #     aria2c -x 16 -s 16 -i ../download-list.txt \
      #         --max-connection-per-server=16 \
      #         --retry-wait=3 \
      #         --max-tries=100 \
      #         --continue=true

      - name: Run
        run: |
            mkdir -p ~/.linkis-build-cache
            cp -r linkis-build-cache/* ~/.linkis-build-cache

      - name: Save
        uses: actions/cache/save@v4
        with:
          path: ~/.linkis-build-cache
          key: ${{ runner.os }}-linkis-${{ hashFiles('linkis-dist/docker/scripts/prepare-ldh-image.sh') }}

      # - name: Save
      #   uses: actions/cache/save@v4
      #   with:
      #     path: linkis-build-cache
      #     key: ${{ runner.os }}-linkis-
